<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Create LDA</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="exceljsmin.js"></script>
    <link
      rel="stylesheet"
      href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"
    />
    <style>
      body {
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <h1 class="ms-font-xl">Create LDA File</h1>
    <p class="ms-font-m">This will create a new Excel file with students who have not attended recently.</p>
    <button id="create-lda" class="ms-Button ms-Button--primary">Create File</button>

    <script>
      (function () {
        "use strict";
        Office.onReady(function () {
          $(document).ready(function () {
            $("#create-lda").click(createLDA);
          });
        });

        /**
         * Converts a JavaScript Date object to an Excel serial number (OA date).
         * @param {Date} date The JavaScript Date to convert.
         * @returns {number} The date as an Excel serial number.
         */
        function toOADate(date) {
            // Excel's epoch starts on 1899-12-30.
            // 25569 is the number of days between the UNIX epoch (1970-01-01) and Excel's epoch.
            return (date.getTime() / 86400000) + 25569.0;
        }

        function createLDA() {
          Excel.run(function (context) {
            var masterSheet = context.workbook.worksheets.getItem("Master List");
            var table = masterSheet.tables.getItemAt(0);
            var ldaColumn = table.columns.getItem("Last Day Attended");
            var headerRange = table.getHeaderRowRange().load("values");
            var bodyRange = table.getDataBodyRange().load("values");

            return context
              .sync()
              .then(function () {
                // Get the setting for "days out" from the document settings.
                // Fallback to a default of 6 if not set.
                var ldaDaysOutSetting = Office.context.document.settings.get("ldaDaysOut");
                var daysOut = (ldaDaysOutSetting !== null && ldaDaysOutSetting !== undefined) ? ldaDaysOutSetting : 6;

                // Calculate the date to filter by
                var today = new Date();
                var filterDate = new Date(today);
                filterDate.setDate(today.getDate() - daysOut);

                // Convert the JS date to Excel's serial number format for filtering
                var filterDateSerial = toOADate(filterDate);

                // Apply a custom filter to get all dates less than or equal to the filter date
                ldaColumn.filter.applyCustom({
                    filterOn: Excel.FilterOn.custom,
                    criterion1: "<=" + filterDateSerial
                });

                return context.sync();
              })
              .then(function () {
                var filteredRange = table.getRange().getVisibleView();
                var filteredValues = filteredRange.load("values");
                return context.sync().then(function () {
                  return filteredValues.values;
                });
              })
              .then(function (visibleData) {
                  // Clear the filter after getting the data
                  ldaColumn.filter.clear();

                  if (visibleData.length <= 1) { // Only headers are visible
                      console.log("No students found matching the LDA criteria.");
                      // You might want to show a message to the user here.
                      Office.context.ui.messageParent("No data");
                      return context.sync();
                  }

                  // Create a new workbook and add the data
                  const newWorkbook = new ExcelJS.Workbook();
                  const newSheet = newWorkbook.addWorksheet("Todays LDA");
                  newSheet.addRows(visibleData);

                  // Create the file
                  return newWorkbook.xlsx.writeBuffer().then(function (buffer) {
                      const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                      const url = window.URL.createObjectURL(blob);
                      const a = document.createElement("a");
                      a.href = url;
                      a.download = "Todays LDA.xlsx";
                      a.click();
                      window.URL.revokeObjectURL(url);
                      Office.context.ui.messageParent("Success");
                  });
              })
              .catch(function (error) {
                  console.log("Error: " + error);
                  if (error instanceof OfficeExtension.Error) {
                      console.log("Debug info: " + JSON.stringify(error.debugInfo));
                  }
                  Office.context.ui.messageParent("Error");
              });
          });
        }
      })();
    </script>
  </body>
</html>
