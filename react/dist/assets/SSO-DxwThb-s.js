import{r as S,j as o,L as j,y as p}from"./index-mSQb59_k.js";const k={SSO_TIMEOUT:1e4};function A(){return!(typeof Office>"u"||!Office.auth||!Office.auth.getAccessToken)}function E(){return A()}function x(e){try{const r=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),i=decodeURIComponent(atob(r).split("").map(function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join("")),t=JSON.parse(i);return t.name||t.preferred_username||"Unknown User"}catch(s){return console.error("Failed to decode JWT:",s),null}}function b(e){try{const r=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),i=decodeURIComponent(atob(r).split("").map(function(f){return"%"+("00"+f.charCodeAt(0).toString(16)).slice(-2)}).join("")),t=JSON.parse(i),n={name:t.name||t.preferred_username||"Unknown",email:t.preferred_username||t.upn||t.email,tenantId:t.tid,objectId:t.oid,roles:t.roles||[]};return typeof window<"u"&&window.localStorage&&(localStorage.setItem("SSO_USER_INFO",JSON.stringify(n)),console.log("SSO: User info cached to localStorage")),n}catch(s){return console.error("Failed to cache user info from token:",s),null}}async function y(e){if(!e||!e.email){console.warn("SSO: Cannot save user - invalid user info");return}try{await Excel.run(async s=>{const r=s.workbook.settings,i=r.getItemOrNullObject("sso_users");i.load("value"),await s.sync();let t=[];if(i.value)try{t=JSON.parse(i.value),Array.isArray(t)||(t=[])}catch(d){console.error("SSO: Failed to parse existing users",d),t=[]}const n=t.findIndex(d=>d.email===e.email||e.objectId&&d.objectId===e.objectId),f={name:e.name,email:e.email,tenantId:e.tenantId,objectId:e.objectId,roles:e.roles||[],lastLogin:new Date().toISOString()};n!==-1?(t[n]=f,console.log("SSO: Updated existing user in workbook settings")):(t.push(f),console.log("SSO: Added new user to workbook settings")),r.add("sso_users",JSON.stringify(t)),await s.sync(),console.log("SSO: User info saved to workbook settings")})}catch(s){console.error("SSO: Failed to save user to workbook settings",s)}}function v(){const[e,s]=S.useState(null),[r,i]=S.useState(null),[t,n]=S.useState(!1);async function f(d={}){const{silent:m=!1,timeout:w=k.SSO_TIMEOUT}=d;n(!0);try{if(!window.Office||!Office.auth||!Office.auth.getAccessToken)throw new Error("Office SSO API is not available");const l=new Promise((h,c)=>setTimeout(()=>c(new Error("SSO timeout")),w)),g=await Promise.race([Office.auth.getAccessToken({allowSignInPrompt:!m,allowConsentPrompt:!m,forMSGraphAccess:!0}),l]);return s(g),i(null),n(!1),g}catch(l){const g=l.code||0,h=l.code?`Error ${l.code}: ${l.message}`:l.message;return console.error("SSO Error:",h),g>=13e3&&g<=13012||i(h),s(null),n(!1),null}}return{token:e,error:r,isLoading:t,getAccessToken:f}}const U="SSO_USER",C="SSO_MODE";function T({onNameSelect:e}){const{getAccessToken:s,error:r,isLoading:i}=v(),[t,n]=S.useState("auto"),[f,d]=S.useState(!1),[m,w]=S.useState(!1);S.useEffect(()=>{if(m)return;(async()=>{if(w(!0),!E()){console.log("SSO: Force fallback mode enabled or SSO not configured"),n("sso");return}console.log("SSO: Auto-attempting silent SSO...");try{const a=await s({silent:!0});if(a){const u=x(a);if(u){console.log("SSO: Silent SSO succeeded"),l(u,"sso");const O=b(a);O&&await y(O),p.success(`Welcome back, ${u}!`,{position:"bottom-center"}),e&&e(u,a),n("sso");return}}}catch{console.log("SSO: Silent SSO failed, showing login options")}n("sso"),d(!0)})()},[m]);const l=(c,a)=>{try{typeof window<"u"&&window.localStorage&&(localStorage.setItem(U,c),localStorage.setItem(C,a))}catch(u){console.warn("Failed to cache user to localStorage",u)}},g=async()=>{console.log("SSO: Manual SSO login triggered");const c=await s({silent:!1});if(c){const a=x(c);if(a){l(a,"sso");const u=b(c);u&&await y(u),p.success(`Success! Logged in as: ${a}`,{position:"bottom-center"}),e&&e(a,c),n("sso")}else p.error("Failed to decode user information from token",{position:"bottom-center"})}else p.error(`SSO login failed${r?`: ${r}`:""}`,{position:"bottom-center"}),d(!0)},h=()=>{const c="Guest";l(c,"guest"),p.success("Continuing as Guest",{position:"bottom-center"}),e&&e(c,null)};return o.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh]",children:[o.jsxs("div",{className:"mb-8 text-center",children:[o.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Welcome!"}),o.jsx("p",{className:"text-lg text-gray-600",children:"Please sign in to get started."})]}),o.jsxs("div",{className:"flex flex-col items-center mb-4 space-y-2 w-64",children:[o.jsx("button",{className:"w-full px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-900 transition flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:g,disabled:i,children:i?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white"}),o.jsx("span",{children:"Signing in..."})]}):o.jsxs(o.Fragment,{children:[o.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 20 20",xmlns:"http://www.w3.org/2000/svg",children:[o.jsx("rect",{x:"1",y:"1",width:"8",height:"8",fill:"#F25022"}),o.jsx("rect",{x:"11",y:"1",width:"8",height:"8",fill:"#7FBA00"}),o.jsx("rect",{x:"1",y:"11",width:"8",height:"8",fill:"#00A4EF"}),o.jsx("rect",{x:"11",y:"11",width:"8",height:"8",fill:"#FFB900"})]}),o.jsx("span",{children:"Sign in with Microsoft"})]})}),o.jsx("button",{className:"w-full px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition font-medium",onClick:h,children:"Continue as Guest"})]}),r&&o.jsxs("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm max-w-md",children:[o.jsx("p",{className:"font-semibold",children:"Authentication Error"}),o.jsx("p",{className:"mt-1",children:r})]}),o.jsx(j,{})]})}export{T as default,v as useOfficeSSO};
