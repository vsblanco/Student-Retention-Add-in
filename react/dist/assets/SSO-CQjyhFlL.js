import{r as u,j as e,L as b,y as S}from"./index-BCIDgHsX.js";const y={SSO_TIMEOUT:1e4};function j(){return!(typeof Office>"u"||!Office.auth||!Office.auth.getAccessToken)}function A(){return j()}function O(n){try{const a=n.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),l=decodeURIComponent(atob(a).split("").map(function(o){return"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)}).join("")),t=JSON.parse(l);return t.name||t.preferred_username||"Unknown User"}catch(c){return console.error("Failed to decode JWT:",c),null}}function w(n){try{const a=n.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),l=decodeURIComponent(atob(a).split("").map(function(h){return"%"+("00"+h.charCodeAt(0).toString(16)).slice(-2)}).join("")),t=JSON.parse(l),o={name:t.name||t.preferred_username||"Unknown",email:t.preferred_username||t.upn||t.email,tenantId:t.tid,objectId:t.oid,roles:t.roles||[]};return typeof window<"u"&&window.localStorage&&(localStorage.setItem("SSO_USER_INFO",JSON.stringify(o)),console.log("SSO: User info cached to localStorage")),o}catch(c){return console.error("Failed to cache user info from token:",c),null}}function E(){const[n,c]=u.useState(null),[a,l]=u.useState(null),[t,o]=u.useState(!1);async function h(p={}){const{silent:g=!1,timeout:x=y.SSO_TIMEOUT}=p;o(!0);try{if(!window.Office||!Office.auth||!Office.auth.getAccessToken)throw new Error("Office SSO API is not available");const i=new Promise((m,s)=>setTimeout(()=>s(new Error("SSO timeout")),x)),d=await Promise.race([Office.auth.getAccessToken({allowSignInPrompt:!g,allowConsentPrompt:!g,forMSGraphAccess:!0}),i]);return c(d),l(null),o(!1),d}catch(i){const d=i.code||0,m=i.code?`Error ${i.code}: ${i.message}`:i.message;return console.error("SSO Error:",m),d>=13e3&&d<=13012||l(m),c(null),o(!1),null}}return{token:n,error:a,isLoading:t,getAccessToken:h}}const k="SSO_USER",C="SSO_MODE";function U({onNameSelect:n}){const{getAccessToken:c,error:a,isLoading:l}=E(),[t,o]=u.useState("auto"),[h,p]=u.useState(!1),[g,x]=u.useState(!1);u.useEffect(()=>{if(g)return;(async()=>{if(x(!0),!A()){console.log("SSO: Force fallback mode enabled or SSO not configured"),o("sso");return}console.log("SSO: Auto-attempting silent SSO...");try{const r=await c({silent:!0});if(r){const f=O(r);if(f){console.log("SSO: Silent SSO succeeded"),i(f,"sso"),w(r),S.success(`Welcome back, ${f}!`,{position:"bottom-center"}),n&&n(f,r),o("sso");return}}}catch{console.log("SSO: Silent SSO failed, showing login options")}o("sso"),p(!0)})()},[g]);const i=(s,r)=>{try{typeof window<"u"&&window.localStorage&&(localStorage.setItem(k,s),localStorage.setItem(C,r))}catch(f){console.warn("Failed to cache user to localStorage",f)}},d=async()=>{console.log("SSO: Manual SSO login triggered");const s=await c({silent:!1});if(s){const r=O(s);r?(i(r,"sso"),w(s),S.success(`Success! Logged in as: ${r}`,{position:"bottom-center"}),n&&n(r,s),o("sso")):S.error("Failed to decode user information from token",{position:"bottom-center"})}else S.error(`SSO login failed${a?`: ${a}`:""}`,{position:"bottom-center"}),p(!0)},m=()=>{const s="Guest";i(s,"guest"),S.success("Continuing as Guest",{position:"bottom-center"}),n&&n(s,null)};return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh]",children:[e.jsxs("div",{className:"mb-8 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Welcome!"}),e.jsx("p",{className:"text-lg text-gray-600",children:"Please sign in to get started."})]}),e.jsxs("div",{className:"flex flex-col items-center mb-4 space-y-2 w-64",children:[e.jsx("button",{className:"w-full px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-900 transition flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:d,disabled:l,children:l?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white"}),e.jsx("span",{children:"Signing in..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 20 20",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("rect",{x:"1",y:"1",width:"8",height:"8",fill:"#F25022"}),e.jsx("rect",{x:"11",y:"1",width:"8",height:"8",fill:"#7FBA00"}),e.jsx("rect",{x:"1",y:"11",width:"8",height:"8",fill:"#00A4EF"}),e.jsx("rect",{x:"11",y:"11",width:"8",height:"8",fill:"#FFB900"})]}),e.jsx("span",{children:"Sign in with Microsoft"})]})}),e.jsx("button",{className:"w-full px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition font-medium",onClick:m,children:"Continue as Guest"})]}),a&&e.jsxs("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm max-w-md",children:[e.jsx("p",{className:"font-semibold",children:"Authentication Error"}),e.jsx("p",{className:"mt-1",children:a})]}),e.jsx(b,{})]})}export{U as default,E as useOfficeSSO};
